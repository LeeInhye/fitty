<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="attendanceMapper">

<resultMap id="attendanceResult" type="Attendance">
		<result column="att_no" property="attNo"/>
		<result column="emp_no" property="empNo"/>
		<result column="att_date" property="attDate"/>
		<result column="att_in" property="attIn"/>
		<result column="att_out" property="attOut"/>
		<result column="att_status" property="attStatus"/>
		<result column="att_plus_work" property="attPlusWork"/>
		<result column="att_nwork_time" property="attNworkTime"/>
		<result column="att_pwork_time" property="attPworkTime"/>
		<result column="countO" property="countO"/>
		<result column="countX" property="countX"/>
		<result column="countL" property="countL"/>
		<result column="countE" property="countE"/>
		<result column="countYH" property="countYH"/>
		<result column="countV" property="countV"/>
		<result column="countPtime" property="countPtime"/>
</resultMap>
  
  <select id="selectAllAttList" resultMap="attendanceResult">
  select emp_no
  		 , att_date
  	     , att_status
  	  from tb_att
  	 where emp_no = #{empNo}
  	   and att_date BETWEEN TO_DATE(to_char((select trunc((to_date( #{thisYear} || '-' || #{thisMonth} || '-01','YYYY-MM-DD')), 'MM') from dual),'YYYY-MM-DD')) 
                        AND TO_DATE(to_char(sysdate,'YYYY-MM-DD'))
  	<!-- 
  	 select emp_no
  		 , att_date
  	     , att_status
  	  from tb_att
  	 where emp_no = #{empNo}
  	   and att_date BETWEEN TO_DATE(to_char((select trunc((to_date( #{thisYear} || '/' || #{thisMonth} || '/01','YYYY-MM-DD')), 'MM') from dual),'YYYY-MM-DD')) 
                        AND TO_DATE(to_char((select last_day( #{thisYear} || '/' || #{thisMonth} || '/01') from dual),'YYYY-MM-DD'))
  	
  	-->
  </select>
	<!-- // AND TO_DATE(to_char(sysdate,'YYYY-MM-DD')) -->  
  
  <select id="selectCountList" resultMap="attendanceResult">
	 select (
        select count(*) as "countO"
          from tb_att
         where emp_no = #{empNo}
           and att_date between to_date(to_char((select trunc((to_date( #{thisYear} || '/' || #{thisMonth} || '/01','YYYY-MM-DD')), 'MM') from dual),'YYYY-MM-DD')) 
  	   					and to_date(to_char((select last_day( #{thisYear} || '/' || #{thisMonth} || '/01') from dual),'YYYY-MM-DD'))
           and att_status = 'O'
    )as "countO"
     , (
        select count(*) as "countX"
          from tb_att
         where emp_no = #{empNo}
           and att_date between to_date(to_char((select trunc((to_date( #{thisYear} || '/' || #{thisMonth} || '/01','YYYY-MM-DD')), 'MM') from dual),'YYYY-MM-DD')) 
  	   					and to_date(to_char((select last_day( #{thisYear} || '/' || #{thisMonth} || '/01') from dual),'YYYY-MM-DD'))
           and att_status = 'X' 
    )as "countX"
     , (
       select count(*) as "countL"
          from tb_att
         where emp_no = #{empNo}
          and att_date between to_date(to_char((select trunc((to_date( #{thisYear} || '/' || #{thisMonth} || '/01','YYYY-MM-DD')), 'MM') from dual),'YYYY-MM-DD')) 
  	   					and to_date(to_char((select last_day( #{thisYear} || '/' || #{thisMonth} || '/01') from dual),'YYYY-MM-DD'))
           and att_status = 'L'   
    ) as "countL"
     , (
        select count(*) as "countE"
          from tb_att
         where emp_no = #{empNo}
           and att_date between to_date(to_char((select trunc((to_date( #{thisYear} || '/' || #{thisMonth} || '/01','YYYY-MM-DD')), 'MM') from dual),'YYYY-MM-DD')) 
  	   					and to_date(to_char((select last_day( #{thisYear} || '/' || #{thisMonth} || '/01') from dual),'YYYY-MM-DD'))
           and att_status = 'E'  
    ) as "countE"
     , (
        select count(*) as "countYH"
          from tb_att
         where emp_no = #{empNo}
           and att_date between to_date(to_char((select trunc((to_date( #{thisYear} || '/' || #{thisMonth} || '/01','YYYY-MM-DD')), 'MM') from dual),'YYYY-MM-DD')) 
  	   					and to_date(to_char((select last_day( #{thisYear} || '/' || #{thisMonth} || '/01') from dual),'YYYY-MM-DD'))
           and att_status in ('Y' , 'H')
    ) as "countYH"
     , (
          select count(*) as "countV"
          from tb_att
         where emp_no = #{empNo}
           and att_date between to_date(to_char((select trunc((to_date( #{thisYear} || '/' || #{thisMonth} || '/01','YYYY-MM-DD')), 'MM') from dual),'YYYY-MM-DD')) 
  	   					and to_date(to_char((select last_day( #{thisYear} || '/' || #{thisMonth} || '/01') from dual),'YYYY-MM-DD'))
           and att_status = 'V'
    ) as "countV"
     , (
        select sum(att_pwork_time)
          from tb_att
          where emp_no = #{empNo}
           and att_date between to_date(to_char((select trunc((to_date( #{thisYear} || '/' || #{thisMonth} || '/01','YYYY-MM-DD')), 'MM') from dual),'YYYY-MM-DD')) 
  	   					and to_date(to_char((select last_day( #{thisYear} || '/' || #{thisMonth} || '/01') from dual),'YYYY-MM-DD'))
            and att_status = 'P'
    ) as "countPtime"
  from tb_att
  </select>
  
  
  
  <insert id="insertAttendance">
  	DECLARE
	  date1 DATE := TO_DATE( #{thisYear} || '0101','yyyy-mm-dd');
	  date2 DATE := TO_DATE( #{thisYear} || '1231','yyyy-mm-dd');
	BEGIN
	  FOR i IN 1..(date2 - date1 + 1) LOOP
	   insert into tb_att ( att_no, emp_no, att_date, att_in, att_out, att_status, att_plus_work)
	   values (SEQ_ATT_NO.NEXTVAL, ${empNo}, (TO_CHAR(date1 + i - 1, 'yyyy-mm-dd')), null, null, 'B', 'N');
	  END LOOP;
	END;
  </insert>
  
  <update id="updateAttendanceStatus">
  <![CDATA[
  update tb_att
	set att_status = 'X'
	where emp_no =  ${empNo}
	  and att_date in 
	(select "att_date"
	   from(
	select level
	     , trunc(to_date('22/01/01', 'YY/MM/DD'), 'MM') + level -1 "att_date"
	     , to_char(trunc(to_date('22/01/01', 'YY/MM/DD'), 'MM') + level - 1 ,'DY') "요일"
	  from dual
	connect by level <= 365
	)
	where 요일 in ('월', '화', '수', '목', '금'))
  ]]>
  </update>


</mapper>
